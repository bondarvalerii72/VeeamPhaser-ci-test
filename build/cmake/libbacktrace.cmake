# Fetch and build libbacktrace

include(FetchContent)
FetchContent_Declare(
    libbacktrace
    GIT_REPOSITORY https://github.com/ianlancetaylor/libbacktrace.git
    GIT_SHALLOW    TRUE
)
FetchContent_MakeAvailable(libbacktrace)

# Run `./configure` in the libbacktrace source directory
execute_process(
    COMMAND ./configure --host=${HOST}
    WORKING_DIRECTORY ${libbacktrace_SOURCE_DIR}
    RESULT_VARIABLE CONFIGURE_RESULT
)

# Check if configure was successful
if(NOT CONFIGURE_RESULT EQUAL 0)
    message(FATAL_ERROR "libbacktrace configure failed")
endif()

# Build the library using `make` (uses the Makefile generated by `./configure`)
execute_process(
    COMMAND make
    WORKING_DIRECTORY ${libbacktrace_SOURCE_DIR}
    RESULT_VARIABLE MAKE_RESULT
    OUTPUT_QUIET
    ERROR_QUIET
)

# Check if make was successful
if(NOT MAKE_RESULT EQUAL 0)
    message(FATAL_ERROR "libbacktrace make failed")
endif()

# Make sure to link the libbacktrace library in your final target
set(COMMON_LIBS ${COMMON_LIBS} ${libbacktrace_SOURCE_DIR}/.libs/libbacktrace.a)
set(COMMON_INCLUDE_DIRS ${COMMON_INCLUDE_DIRS} ${libbacktrace_SOURCE_DIR})
